---
title: "p8105_hw2_ml5218"
author: "Muying Li"
date: "2025-09-29"
output: github_document
---


Load packages
```{r}
library(tidyverse)
library(readxl)
```

# Problem 1

## Data Wrangling
Tidy `pols-month.csv`
```{r}
pols = 
  read_csv('data/fivethirtyeight_datasets/pols-month.csv') |> 
  janitor::clean_names() |> 
  # break up the variable mon into integer variables year, month, and day
  separate(
    mon, sep="-", into=c("year", "month", "day")
  ) |> 
  # convert into integer variables
  mutate(
    year = as.integer(year),
    month = as.integer(month),
    day = as.integer(day)
  ) |> 
  # replace month number with month name
  mutate(
    month = case_when(
      month == 1 ~ "January",
      month == 2 ~ "February",
      month == 3 ~ "March",
      month == 4 ~ "April",
      month == 5 ~ "May",
      month == 6 ~ "June",
      month == 7 ~ "July",
      month == 8 ~ "August",
      month == 9 ~ "September",
      month == 10 ~ "October",
      month == 11 ~ "November",
      month == 12 ~ "December"
    )
  ) |> 
  # create a president variable taking values gop and dem
  mutate(
    president = case_when(
      prez_gop > prez_dem ~ "gop",
      prez_dem > prez_gop ~ "dem"
    )
  )|> 
  # remove prez_dem and prez_gop, remove the day variable
  select(-prez_dem, -prez_gop, -day) 
```
Tidy `unemployment.csv`
```{r}
unemployment = 
  read_csv('data/fivethirtyeight_datasets/unemployment.csv') |> 
  janitor::clean_names() |>
  # tidy the data
  pivot_longer(
    cols = jan:dec,
    names_to = "month",
    values_to = "unemployment_rate"
  ) |> 
  # convert year to integer
  mutate(year = as.integer(year)) |> 
  # replace month abbreviation with month name
  mutate(
    month = case_when(
      month == "jan" ~ "January",
      month == "feb" ~ "February",
      month == "mar" ~ "March",
      month == "apr" ~ "April",
      month == "may" ~ "May",
      month == "jun" ~ "June",
      month == "jul" ~ "July",
      month == "aug" ~ "August",
      month == "sep" ~ "September",
      month == "oct" ~ "October",
      month == "nov" ~ "November",
      month == "dec" ~ "December"
    ),
  ) |>
  # arrange according to year and month
  mutate(month = factor(month, levels = month.name)) |> 
  arrange(year, month) |> 
  # make year and month are the leading columns
  relocate(year, month)
```
Tidy `snp.csv`
```{r}
snp = 
  read_csv('data/fivethirtyeight_datasets/snp.csv') |> 
  janitor::clean_names() |> 
  # break up the variable mon into integer variables year, month, and day
  separate(
    date, sep="/", into=c("month", "day", "year")
  ) |> 
  # convert into integer variables
  mutate(
    year = as.integer(year),
    month = as.integer(month)
  ) |> 
  # replace month number with month name
  mutate(
    month = case_when(
      month == 1 ~ "January",
      month == 2 ~ "February",
      month == 3 ~ "March",
      month == 4 ~ "April",
      month == 5 ~ "May",
      month == 6 ~ "June",
      month == 7 ~ "July",
      month == 8 ~ "August",
      month == 9 ~ "September",
      month == 10 ~ "October",
      month == 11 ~ "November",
      month == 12 ~ "December"
    )
  ) |> 
  # convert year to yyyy format
  mutate(
    year = case_when(
      year <= 25 ~ year+2000,
      year > 25 ~ year+1900
    )
  ) |> 
  # arrange according to year and month
  mutate(month = factor(month, levels = month.name)) |> 
  arrange(year, month) |> 
  # make year and month are the leading columns
  relocate(year, month) |> 
  # remove day 
  select(-day)
```

Join the datasets by merging `snp` into `pols`, and merging `unemployment` into the result.
```{r}
result = 
  left_join(pols, snp, by = c("year", "month")) |> 
  left_join(unemployment, by = c("year", "month"))
result
```

## Description about the Datasets
Basic summary
```{r eval = FALSE}
# dimensions of the dataset
dim(result)
# structure of the dataset
str(result)
# missing values
colSums(is.na(result))
# summary statistics
summary(result)
```

*Write a short paragraph about these datasets. Explain briefly what each dataset contained, and describe the resulting dataset (e.g. give the dimension, range of years, and names of key variables).*

### `pols`
`pols` (from `pols-month.csv`) contains `r nrow(pols)` observations of `r ncol(pols)` variables related to the number of national politicians who are democratic or republican in a specific month of the associated year from `r min(pols$year)` to `r max(pols$year)`:

- `year`: year of the count on that row
- `month`: month of the count on that row
- `gov_gop`, `sen_gop`, `rep_gop`: the number of Republican Party representatives in government, Senate, and House, respectively on the associated month and year
- `gov_dem`, `sen_dem`, `rep_dem`: the number of Democratic Party representatives in government, Senate, and House, respectively on the associated month and year
- `president`: political affiliation of the U.S. president on the associated month and year (`dem` = democratic, `gop` = republican)

This dataset contains `r colSums(is.na(pols))` missing values in columns `r colnames(pols)` respectively, indicating no missing values. 


### `unemployment`
`unemployment` (from `unemployment.csv`) contains `r nrow(unemployment)` observations of `r ncol(unemployment)` variables related to percentage of unemployment in a specific month of the associated year from `r min(unemployment$year)` to `r max(unemployment$year)`:

- `year`: year of the measurements on that row
- `month`: month of the count on that row
- `unemployment_rate`: percentage of unemployment of the associated year and month

However, this dataset contains `r colSums(is.na(unemployment))` missing values in columns `r colnames(unemployment)` respectively, corresponding to no records of unemployment rate from July 2015 to December 2015. 


### `snp`
`snp` (from `snp.csv`) contains `r nrow(snp)` observations of `r ncol(snp)` variables related to  Standard & Poorâ€™s stock market index (S&P) in a specific month of the associated year from `r min(snp$year)` to `r max(snp$year)`:

- `year`: year of the measurements on that row
- `month`: month of the measurements on that row
- `close`: the closing values of the S&P stock index on the associated year and month

This dataset contains `r colSums(is.na(snp))` missing values in columns `r colnames(snp)` respectively, indicating no missing values. 


### Merged dataset `result`
`result` includes merged data from `unemployment` and `snp` into `pols`. Therefore, it contains information on political party representation, the closing values of the S&P stock index, and the percentage of unemployment, from January 1947 to June 2015 (same range as `pols`). It includes a total of `r nrow(result)` rows/observations and `r ncol(result)` columns/variables as described above. 


# Problem 2

## Data Wrangling
Mr. Trash Wheel
```{r}
mr_trash = 
  read_excel(
    "data/202409 Trash Wheel Collection Data.xlsx", 
    sheet = "Mr. Trash Wheel",
    range = "A2:N653"
    ) |> 
  janitor::clean_names() |> 
  # no need date
  select(-date) |> 
  # add name of the wheel
  mutate(
    wheel = "mr"
  ) |> 
  # round sports balls to the nearest integer and converts the result to an integer variable 
  mutate(sports_balls = as.integer(round(sports_balls))) |> 
  # pivot the data longer for types of trash
  pivot_longer(
    cols = plastic_bottles:sports_balls,
    names_to = "trash_type",
    values_to = "count"
  ) |> 
  # pivot the data longer for weight and volume 
  pivot_longer(
    cols = weight_tons:volume_cubic_yards,
    names_to = "measurement_type",
    values_to = "value"
  ) |> 
  # move homes to the last column 
  relocate(homes_powered, .after = last_col()) |> 
  # convert year and month to integer and factor
  mutate(
    month = str_to_title(month),
    month = factor(month, levels = month.name),
    year = as.integer(year)
  )
mr_trash
filter(mr_trash, is.na(year) | is.na(month))
```
Professor Trash Wheel 
```{r}
prof_trash = 
  read_excel(
    "data/202409 Trash Wheel Collection Data.xlsx", 
    sheet = "Professor Trash Wheel",
    range = "A2:M121"
    ) |> 
  janitor::clean_names() |> 
  # no need date
  select(-date) |> 
  # add name of the wheel
  mutate(
    wheel = "prof"
  ) |> 
  # pivot the data longer for types of trash
  pivot_longer(
    cols = plastic_bottles:wrappers,
    names_to = "trash_type",
    values_to = "count"
  ) |> 
  # pivot the data longer for weight and volume 
  pivot_longer(
    cols = weight_tons:volume_cubic_yards,
    names_to = "measurement_type",
    values_to = "value"
  ) |> 
  # move homes to the last column 
  relocate(homes_powered, .after = last_col()) |> 
  # convert year and month to integer and factor
  mutate(
    month = str_to_title(month),
    month = factor(month, levels = month.name),
    year = as.integer(year)
  ) |> 
  # only keep non-empty rows
  filter(!is.na(year))

prof_trash
```

Gwynnda
```{r}
gwy_trash = 
  read_excel(
    "data/202409 Trash Wheel Collection Data.xlsx", 
    sheet = "Gwynnda Trash Wheel",
    range = "A2:L265"
    ) |> 
  janitor::clean_names() |> 
  # no need date
  select(-date) |> 
  # add name of the wheel
  mutate(
    wheel = "gwy"
  ) |> 
  # pivot the data longer for types of trash
  pivot_longer(
    cols = plastic_bottles:wrappers,
    names_to = "trash_type",
    values_to = "count"
  ) |> 
  # pivot the data longer for weight and volume 
  pivot_longer(
    cols = weight_tons:volume_cubic_yards,
    names_to = "measurement_type",
    values_to = "value"
  ) |> 
  # move homes to the last column 
  relocate(homes_powered, .after = last_col()) |> 
  # convert year and month to integer and factor
  mutate(
    month = str_to_title(month),
    month = factor(month, levels = month.name),
    year = as.integer(year)
  )
gwy_trash
```

Combine this with the 3 wheel datasets 
```{r}
wheels = 
  bind_rows(mr_trash, prof_trash, gwy_trash) |> 
  # move wheel, year, month as leading columns 
  relocate(wheel, year, month)
```


## Description about `wheels` 
*Write a paragraph about these data; you are encouraged to use inline R. Be sure to note the number of observations in the resulting dataset, and give examples of key variables.*

The `wheels` contains trash collection data of 3 wheels: Mr. Trash Wheel, Professor Trash Wheel, and Gwynnda Trash Wheel, from `r min(wheels$year)` to `r max(wheels$year)`. It includes a total of `r nrow(wheels)` observations of `r ncol(wheels)` variables. Each row/observation indicates the trash collection information of a specific wheel's dumpster in a month and a year such as amount of total litter and litter type, and number of homes powered by the trash collected.

Key variables include:

- `wheel`: wheel identifier indicating which wheel the trash was collected from (`mr` = Mr. Trash, `prof` = Professor, `gwy` = Gwynnda)
- `year`: year the data was collected
- `month`: month the data was collected
- `dumpster`: dumpster number (in integer, starting from 1)
- `trash_type`: type of trash collected, including `plastic_bottles`, `polystyrene`, `cigarette_butts`, `glass_bottles`, `plastic_bags`, `wrappers`, `sports_balls`
- `count`: counts of how many of a specific trash type was collected (in integer)
- `measurement_type`: type of measurement of total trash collected (such as weight in tons (`weight_tons`) or volume in cubic yards (`volume_cubic_yards`))
- `value`: numeric value of a specific measurement type of total trash collected


*What was the total weight of trash collected by Professor Trash Wheel?*
```{r}
prof_total_weight = 
  filter(
    wheels, 
    wheel == "prof", 
    measurement_type == "weight_tons"
  ) |> 
  select(value) |> 
  sum()
```
The total weight of trash collected by Professor Trash Wheel is `r prof_total_weight` tons. 

*What was the total number of cigarette butts collected by Gwynnda in June of 2022?*
```{r}
gwy_jun22_cig = 
  filter(
    wheels, 
    wheel == "gwy", 
    trash_type == "cigarette_butts",
    year == 2022,
    month == "June"
  ) |> 
  select(count) |> 
  sum()
```
The total number of cigarette butts collected by Gwynnda in June of 2022 is `r format(gwy_jun22_cig, scientific = FALSE)`.

# Problem 3
## Data Wrangling
Zip code
```{r}
zip_code =
  read_csv("data/zillow_data/Zip Codes.csv") |> 
  janitor::clean_names() |> 
  # add "County" to county 
  mutate(
    county = paste(county, "County")
  )
# find duplicate zip codes
#group_by(zip_code, zip_code) |> 
#  filter(n() > 1)
# remove duplicates
#zip_code = distinct(zip_code, zip_code, .keep_all = TRUE)
```

ZORI
```{r}
zori = 
  read_csv("data/zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") |> 
  janitor::clean_names() |> 
    # rename columns 
  rename(
    zip_code = region_name,
    county = county_name
  ) |> 
  # pivot date
  pivot_longer(
    cols = x2015_01_31:last_col(),
    names_to = "date",
    values_to = "rent",
    # remove prefix
    names_prefix = "x"
  ) |> 
  # extract year, month from date
  # break up the variable mon into integer variables year, month, and day
  separate(
    date, sep="_", into=c("year", "month", "day")
  ) |> 
  # convert into integer variables
  mutate(
    year = as.integer(year),
    month = as.integer(month)
  ) |> 
  # replace month number with month name
  mutate(
    month = case_when(
      month == 1 ~ "January",
      month == 2 ~ "February",
      month == 3 ~ "March",
      month == 4 ~ "April",
      month == 5 ~ "May",
      month == 6 ~ "June",
      month == 7 ~ "July",
      month == 8 ~ "August",
      month == 9 ~ "September",
      month == 10 ~ "October",
      month == 11 ~ "November",
      month == 12 ~ "December"
    )
  ) |> 
  mutate(month = factor(month, levels = month.name))
```
Check for completeness and correctness across datasets
```{r}
colSums(is.na(zip_code))
colSums(is.na(zori))
```
Note that in `zip_code`, there are 142 missing neighborhood values, and in `zori`, there are 6834 missing rent values.

Check how many unique zip codes in zip_code and zori respectively:

- zip_code has `r length(unique(zip_code$zip_code))`
- zori has `r length(unique(zori$zip_code))`

Next

- Merge `zip_code` into `zori` by `zip_code` and `county` columns 
- Pivot the date
- Arrange variables and observations in meaningful orders.
```{r}
zori_nyc_zip = 
  left_join(zip_code,zori,by = c("zip_code","county")) |> 
  # rearrange columns
  relocate(zip_code, county, neighborhood, year, month, rent) |> 
  # no need day
  select(-day)
```

Not all columns are necessary in this case. Remove unnecessary columns such as `state_fips`, `state_name`, `city`, `metro`, as all areas are within NY. 
```{r}
tidy_zori_nyc = 
  select(zori_nyc_zip, zip_code, county, neighborhood, year, month, rent)
```

## Description & Question Answering
*Briefly describe the resulting tidy dataset. *

`zori_nyc_zip` contains data from datasets `zip_code` and `zori`, including NYC zip code, neighborhoods within boroughs, and Zillow Observed Rent Index (ZORI) between January 2015 and August 2024. It has a total of `r nrow(zori_nyc_zip)` observations of `r ncol(zori_nyc_zip)` variables. 

`tidy_zori_nyc` is a subset of `zori_nyc_zip` containing only necessary information about NYC zip codes, boroughs, neighborhoods, and ZORI. It has a total of `r nrow(tidy_zori_nyc)` observations of `r ncol(tidy_zori_nyc)` variables. 

Key variables include:

- `zip_code`: zip code of a specific area/region
- `county`: county where the area/region belongs to 
- `neighborhood`: neighborhoods within boroughs
- `year`: year of the data was collected
- `month`: month of the data was collected
- `rent`: zori index, a repeat-rent index that is weighted to the rental housing stock to ensure representativeness across the entire market

*How many total observations exist? How many unique ZIP codes are included, and how many unique neighborhoods?*

- Total observations: `r nrow(zori_nyc_zip)`
- Number of unique zip codes: `r length(unique(zori_nyc_zip$zip_code))`
- Number of unique neighborhoods: `r length(unique(zori_nyc_zip$neighborhood))`

*Which ZIP codes appear in the ZIP code dataset but not in the Zillow Rental Price dataset? Using a few illustrative examples discuss why these ZIP codes might be excluded from the Zillow dataset.*

```{r}
exclusive_zip = anti_join(zip_code, zori, by = "zip_code") |> 
  arrange(zip_code) |> 
  pull(zip_code)
exclusive_zip
```
There are `r length(exclusive_zip)` zip codes appear in the ZIP code dataset but not in the Zillow Rental Price dataset. 

Possible reasons for exclusion:

- Non-residential areas such as 10041 located in the Financial District of Manhattan, where mostly commercial buildings and minimal rental housing. These commerical, industrial, or non-residential regions have ZIP codes where Zillow does not track rental prices. 
- Missing or insufficient price data for less populated or less active rental markets such as 11559 located in Long Island; it may have fewer rental listings available in Zillow's dataset.
- Special cases like post office boxes, government buildings, or military facilities where rental properties might not be tracked; for example, 10199 corresponds to the postal code for USPS Morgan Processing and Distribution Center and does not include residential housing.


*Rental prices fluctuated dramatically during the COVID-19 pandemic. For all available ZIP codes, compare rental prices in January 2021 to prices in January 2020. Make a table that shows the 10 ZIP codes (along with the borough and neighborhood) with largest drop in price from January 2020 to 2021. Comment.*

```{r}
covid_prices = 
  filter(
    tidy_zori_nyc, 
    # January 2020 and January 2021
    (year == 2020 & month  == "January") | (year == 2021 & month == "January"),
    ) |> 
  pivot_wider(
    names_from = year,
    values_from = rent,
    names_prefix = "rent_"
    ) |> 
  filter(
    # available prices for both years
    !is.na(rent_2020) & !is.na(rent_2021)
  ) |> 
  # calculate price difference
  mutate(
    price_change = rent_2021-rent_2020
  ) |> 
  # order by biggest difference to smallest
  arrange(price_change)
```
Below is the table that shows the 10 ZIP codes (along with the borough and neighborhood) with largest drop in price from January 2020 to 2021
```{r}
# top 10 in table format with 10 ZIP codes 
select(covid_prices, zip_code, county, neighborhood, price_change) |> 
  head(10) |> 
  knitr::kable()
```
If we don't want empty neighborhood information, we can drop `NA` rows
```{r}
select(covid_prices, zip_code, county, neighborhood, price_change) |> 
  filter(!is.na(neighborhood)) |> 
  head(10) |> 
  knitr::kable()
```

From the table above, with top 10 zip codes with the largest price change for rental prices, we can find that:

1. All top 10 price drops in rental prices from January 2020 to January 2021 were from New York County with a highest price drop of $912.5966 at 10007, Lower Manhattan. 

2. The neighborhoods in top 10 are primarily in Lower Manhattan (6 out of 10), followed by Gramercy Park (2 out of 10).

3. We can take a further look into the price changes by neighborhood. The results of code below show that the highest mean price drop area is Lower East Side followed by Lower Manhattan, which indicates people moved out from these areas, while Jamaica area had a mean rental price increase at $101; perhaps people were moving out from the city to nearby areas like Jamaica. 
```{r}
# calculate mean price_change for each neighborhood
mean_price_change_by_neighborhood <- 
  group_by(covid_prices, neighborhood) |> 
  summarise(mean_price_change = mean(price_change)) |> 
  arrange(mean_price_change)
mean_price_change_by_neighborhood
```
```{r}
# arrange by descending order
arrange(mean_price_change_by_neighborhood, desc(mean_price_change))
```

